function openTab(evt, tabName) {
    const tabContents = document.getElementsByClassName("tab-content");
    for (let i = 0; i < tabContents.length; i++) {
        tabContents[i].classList.remove("active");
    }

    const tabLinks = document.getElementsByClassName("tab-link");
    for (let i = 0; i < tabLinks.length; i++) {
        tabLinks[i].classList.remove("active");
    }

    document.getElementById(tabName).classList.add("active");
    if (evt) evt.currentTarget.classList.add("active");
    else {
        // Find button with onclick containing tabName
        const buttons = document.getElementsByClassName("tab-link");
        for (let btn of buttons) {
            if (btn.getAttribute('onclick').includes(tabName)) {
                btn.classList.add("active");
                break;
            }
        }
    }
}

// Load history on startup
document.addEventListener('DOMContentLoaded', loadHistory);

function loadHistory() {
    fetch('/api/history')
        .then(response => response.json())
        .then(data => {
            const list = document.getElementById('historyList');
            list.innerHTML = '';
            if (data.length === 0) {
                list.innerHTML = '<div class="placeholder-text">No reports yet.</div>';
                return;
            }
            data.forEach(report => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `
                    <div class="history-info">
                        <strong>${report.idea}</strong>
                        <span>${report.date}</span>
                    </div>
                    <i class="fas fa-chevron-right"></i>
                `;
                item.onclick = () => loadPastReport(report);
                list.appendChild(item);
            });
        });
}

function loadPastReport(report) {
    // 1. Update UI to show loaded state
    document.getElementById('idea').value = report.idea;
    document.getElementById('industry').value = report.industry;
    document.getElementById('region').value = report.region;
    document.getElementById('statusText').innerText = "Loaded from History";
    document.getElementById('progressFill').style.width = "100%";

    // 2. Show downloads
    document.getElementById("downloads").classList.remove("hidden");
    document.getElementById("dl-md").href = `/${report.files.md}`;
    document.getElementById("dl-pdf").href = `/${report.files.pdf}`;
    document.getElementById("dl-ppt").href = `/${report.files.ppt}`;

    // 3. Fetch MD and parse into tabs
    fetch(`/${report.files.md}`)
        .then(r => r.text())
        .then(md => {
            parseMarkdownToTabs(md);
        });
}

function parseMarkdownToTabs(md) {
    // Basic splitting based on ## Headers
    // This assumes the standard format generated by the python script
    const sections = {
        'Market Research': 'Market',
        'Competitor Analysis': 'Competitor',
        'Customer Insights': 'Customer',
        'SWOT Analysis': 'SWOT',
        'Financial Estimation': 'Financial',
        'Risk & Feasibility': 'Risk',
        'Risk Assessment': 'Risk', // Handle both var names if they change
        'Final Strategy': 'Strategy'
    };

    // Clear tabs
    for (let id of Object.values(sections)) {
        document.getElementById(id).innerHTML = "";
    }

    const lines = md.split('\n');
    let currentTab = null;
    let currentContent = "";

    lines.forEach(line => {
        if (line.startsWith('## ')) {
            // New section detected
            if (currentTab) {
                document.getElementById(currentTab).innerHTML = marked.parse(currentContent);
            }

            const title = line.replace('## ', '').trim();
            // Find mapping
            for (let [key, val] of Object.entries(sections)) {
                if (title.includes(key)) {
                    currentTab = val;
                    currentContent = "";
                    break;
                }
            }
        } else {
            currentContent += line + "\n";
        }
    });

    // Flush last buffer
    if (currentTab) {
        document.getElementById(currentTab).innerHTML = marked.parse(currentContent);
    }

    // Open first tab
    openTab(null, 'Market');
}

function startAnalysis() {
    const idea = document.getElementById("idea").value;
    const industry = document.getElementById("industry").value;
    const region = document.getElementById("region").value;

    if (!idea || !industry || !region) {
        alert("Please fill in all fields.");
        return;
    }

    document.getElementById("runBtn").disabled = true;
    document.getElementById("progressFill").style.width = "0%";
    document.getElementById("downloads").classList.add("hidden");

    // Clear tabs with loading skeletons
    const contents = document.getElementsByClassName("tab-content");
    for (let c of contents) {
        c.innerHTML = `
            <div class="skeleton-container">
                <div class="skeleton-line title"></div>
                <div class="skeleton-line"></div>
                <div class="skeleton-line"></div>
                <div class="skeleton-line short"></div>
            </div>`;
    }

    const evtSource = new EventSource(`/stream_analysis?idea=${encodeURIComponent(idea)}&industry=${encodeURIComponent(industry)}&region=${encodeURIComponent(region)}`);

    evtSource.onmessage = function (event) {
        const data = JSON.parse(event.data);

        document.getElementById("statusText").innerText = `${data.name} (${data.status})`;
        const progress = (data.step / 8) * 100;
        document.getElementById("progressFill").style.width = `${progress}%`;

        if (data.status === 'done' && data.content) {
            let tabId = "";
            if (data.name.includes("Market")) tabId = "Market";
            else if (data.name.includes("Competitor")) tabId = "Competitor";
            else if (data.name.includes("Customer")) tabId = "Customer";
            else if (data.name.includes("SWOT")) tabId = "SWOT";
            else if (data.name.includes("Financial")) tabId = "Financial";
            else if (data.name.includes("Risk")) tabId = "Risk";
            else if (data.name.includes("Strategy")) tabId = "Strategy";

            if (tabId) {
                document.getElementById(tabId).innerHTML = marked.parse(data.content);
                // Auto switch to this tab? No, might be annoying. Maybe just unlock it.
            }
        }

        if (data.status === 'complete') {
            evtSource.close();
            document.getElementById("runBtn").disabled = false;
            document.getElementById("statusText").innerText = "Completed!";

            document.getElementById("downloads").classList.remove("hidden");
            document.getElementById("dl-md").href = `/${data.files.md}`;
            document.getElementById("dl-pdf").href = `/${data.files.pdf}`;
            document.getElementById("dl-ppt").href = `/${data.files.ppt}`;

            // Reload history to show the new item
            loadHistory();
        }
    };

    evtSource.onerror = function () {
        console.error("EventSource failed.");
        evtSource.close();
        document.getElementById("runBtn").disabled = false;
    };
}
